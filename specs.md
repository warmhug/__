

# 开发及协作规范(前后端) DevelopCollaborationSpec

> 2020-01 ~ now 整理

### 通用与协同

> 倒排时间，赶着年前做完，年后推广/打绩效。。。功能要完善，体验要求高。。。

- 时间节点
   - MRD/PRD/交互稿 -> 设计稿/系分/接口定义/测试用例 -> 技术评审/测试评审 -> 
   - 后端开发 -> 前端开发 -> 后端接口在日常或开发环境可用 -> 完成开发(后端/前端) -> 
   - 自测(1~2倍开发时间) -> 联调 -> 提测 -> 验收 -> (灰度)发布。
- 需求评审、交互视觉评审。
   - 对 “业务/项目/产品” 背景充分的理解。对产品设计有异议就提出来。不放过 PRD 里的**每个细节**。
   - 脑中过 **2** 遍产品功能的**各个细节**的代码写法，发现并记录**卡壳点或难点**，形成初步“系分”文档。
- 工作量评估
   - 是否是**倒排期**？能投入几个人？各功能点的**优先级**？不能造成 **时间赶+功能多+资源少** 的风险。
   - 影响因素
      - 有其他**并行**需求？旧功能改造/优化？现存bug+代码重构？**穿插**新需求评审？需求变更？
      - 二三方库bug/升级、依赖他人、系统不稳定。沉淀总结。开发环境/电脑卡/被打断/假期。
      - 技术**调研**过程 ~= 30% 开发工作量，如没实际经验(悲观评估/**不做**搞得定的承诺)。
      - 人月神话：核心功能大概率只能一个人做，多人合作考虑到额外的合作成本。
- 测试和发布
   - 自测2遍，走完 **测试用例**，重点验证 **异常流程、edge case、兼容性、UI还原度、E2E** 等问题(使用“线上”真实数据)，必要时做 **全部功能回归测试**。联调验证 **各接口**出入参，数据错误或异常。
   - 测试提问题：是否必现，是否是线上已有问题，非本次迭代范围的缺陷？
- 过程控制
   - **多沟通**，形成**好口碑**，让“业务方/合作方”满意、赞你 信任你。
   - 按功能模块开发、及时合并主分支代码，每天提交代码 **两次+** 并走 MR 和 CR 。
   - 页面/功能模块用到哪些“组件、三方包”。必要时有 “**组件评审**” 环节、沉淀统一基础组件。
   - **优先**解决“容易”的问题，遇到无经验的难点、及时**寻求**帮助；可能要**一整天**解决一个难点。
   - 优化一些细节，可能要 **多次/反复** 修改。


### 编码方式/架构

- **前后端**交互
   - 前后端**分离**的开发方式：本质上、前端页面可以不用存在，后端代码逻辑需要完全自洽。
   - 接口调用入参**最少化**，能给后端只传一个 id，就不再传 name/type 了。
   - 确保数据**尽量全部**来自后端，data -> view。唯一性、一致性、移植性、安全性。
   - **极少数**前端数据源：根据 url 参数或投放渠道不同、显隐某一个按钮/模块。照顾后端性能。
   - 后端数据**结构层级**变更、导致前端页面展示会**报错**，注意变更方式。
- 代码的 "变量名、函数名、文件名" 等命名要「**表意、规范、准确**」。
   - 英文单词在“不能确定”单数或复数时、用单数形式，确定的常见的类似 components / pages 用复数；英文字母太长、建议用 “英文缩写” 代替 (缩写[查询](https://www.abbreviations.com/)、[查询1](https://www.acronymfinder.com/))
   - 涉及到数据的部分，相应的前端命名、要和后端 接口名/数据字段名，尽可能 **保持一致**。
- 任何地方**杜绝**无意义的「**重复代码**」，做抽象，否则会是**无效**、**无用**甚至**有害**(破坏其他功能)的。
   - 用**最少**的代码、**最易**维护的写法，实现功能。工作量体现在代码**质量**、而非数量。
   - 对「问题点/难点」的**真正思考**、并能通过「代码注释」体现出来。
   - 比如，table 列；css 里的重复样式设置。从别的地方大量拷贝的代码。
- 对依赖的「二方库、三方库」要谨慎。
   - 尽量不要有 三方库 依赖，如果需要、找最常用/最活跃的。
   - 为避免不可控的线上故障，根据依赖库的严谨性，选择是否 **锁死** (注意这些库所依赖库的版本可能无法锁死) 其版本。
- 公共的/各个地方都会执行的函数，确保实现的「严谨性」。
- 公共组件的 API 设计，参考并遵守 **设计模式/原则，**设计好「**输入/输出/内部状态**」。
- **避免** hack 的解决办法、临时方案。
- 大数据量的树结构、尽量 **避免**在“多个地方 多次”循环遍历，造成性能问题。
- css 样式 除非是动态地、否则 **不能** 内联到 html 里，而是全部写到 css/less 文件里。
- css 关于 **布局、居中、对齐、伪元素** 等常见的写法。
   - 页面整块以及局部的多列布局，优先使用组件库里的 Row Col 组件 (其次用 flex 布局)
   - **禁止**使用 float 布局（除了极特殊情况）
   - 使用 flex 做"水平/垂直"居中，**禁止**使用 `transform` 等非常规居中方法
   - 常见的 `|` 等页面里的分割线，使用 伪元素/或border 绘制，**禁止 **写多余的 html 标签
   - 一行里的多个元素：建议使用 `span` 等行内标签，使用 `vertical-align` 做对齐
   - 不要 **轻易** 给元素设置 `height` ，而使用 `padding` 达到同样效果
- js 函数、尽量遵守「函数式编程」的优秀原则 ([函数式编程初探](http://www.ruanyifeng.com/blog/2012/04/functional_programming.html)、[函数式编程思维](https://www.zhihu.com/question/28292740))。
   - **单一职责:** 函数应该处理单一任务，比如「提交/取消」放在一个函数处理可能不合适
   - **引用透明**: 函数的运行不依赖于外部变量或"状态"，只依赖于输入的参数
   - **没有副作用**: 不修改外部变量的值
- js 里的状态 string 应该尽量少；参考 [魔数](https://baike.baidu.com/item/%E9%AD%94%E6%95%B0)，bool flag method 解释 [一](https://softwareengineering.stackexchange.com/questions/147977/is-it-wrong-to-use-a-boolean-parameter-to-determine-behavior)、[二](https://stackoverflow.com/questions/6107221/alternatives-to-passing-a-flag-into-a-method)
   - “常量”(比如 table头、后端数据状态枚举) 维护在单一文件里
   - 比如在「确定、取消、删除」等需要标记状态的地方，应该不要或尽量少用 string
- jsx 里不能有 if 语句，不能有 **多于两行 同时 多于两处以上** 的重复代码。
- React 的 全局和组件 state 用法
   - 各处 state **尽量少**，想清楚“数据源”在哪儿，确保是“**单一数据源**”。
   - 全局 state 场景：多页面共用、数据或UI状态**需要保持**(离开再返回页面)。
   - 组件 state 场景：临时的 UI 状态、临时数据。
   - 输入类组件、全部使用 **受控** 写法。
- 页面 view 层代码应尽量简单，主要是 UI 渲染、事件绑定 等 **渲染层强相关** 代码。
- 页面多 request 接连触发 场景处理方法。
   - 比如：评论框+评论列表，当新增/编辑评论后、更新评论列表，可以在 新增 后的 callback (在页面文件) 里 message 提示成功 (不应该再有其他多余代码)，接连的 更新列表 请求，应该在 model (dva) 里发起

> Programming is not a science so much as it is an art. 编程不是一门科学，而是一门艺术。

### 案例

- 从 0-1 开发过程记录：[富交互产品的困境](http://warmhug.github.io/2020/12/30/the-dilemma-of-rich-interactive-products.html)
- [控制期望](http://warmhug.github.io/2021/02/19/do-the-best.html)

迭代需求 (2021-03)：

- 兼容两个域名，网关改变、多个接口数据格式重新梳理。
- 增加区分 url 参数 全局功能(影响面大)，导致增加更多状态、条件判断，对原有大量逻辑重新梳理并改动。
- 换了搜项目的接口、增加两个查项目详情信息接口。

过程：

- 对原来相关代码重构、过程中发现并必须修复相关线上bug 等。10h (超预期6h)
- 新增代码开发量&自测。10h + 5h
- 前后端联调问题(字段缺失/类型不对) 5h (未考虑到)
- 踩坑4h 、修复 视觉细节还原和验收问题 10h+。
- 全过程沟通讨论，三方依赖，环境问题 等。以上时间*0.3。
- 设计稿 delay 1.5 天，后端 delay 1.5天(出接口)，导致 (1.5+1.5)*0.3 的进度延期。

前后端**并行**开发？

- 因为后端的数据“权限/角色”难以mock，导致最多3/4时间并行，其他时间瀑布开发。
- 强制并行会有 “细节不清晰/反复/不能发现深入的问题” 等低效工作。



-------
# PRD 模板
> 2022-08
PRD有三种状态：Draft、 Review、Ready,  其中起草人为产品或研发团队，相关人 review 通过。

修订记录/更新日志
修改日期	修改版本	修改内容	备注

前后端测试负责人、工作量评估。

一、需求背景
1.1 需求来源
1.2 需求描述 
概念对齐/名词定义/关键术语
目标对齐
竞品调研/同类产品调研
使用场景/主要用户/试点用户

二、需求目标
产品定位
产品目标
产品能力
业务问题(业务需求)
功能一览表格
业务流程

三、结构/流程图
3.1 功能结构图
3.2 需求流程图
3.3 交互设计图

四、需求范围
模块 功能 优先级

五、功能性需求
详细需求
详细方案

六、非功能性需求
上线/灰度/回滚方案、兼容性、AB实验、高可用、性能、监控、权限、运维 等。


七、附录
数据分析报告、用户调研报告




-------

# 系分&模板
> 2019-11 - 内部

系分(系统设计+业务分析)的本质其实就是将技术推演的过程前置，所带来的好处就是：问题可以在第一时间发现，第一时间解决，从而最大化的降低了需求变更、方案变更 所带来的沉没成本。

## 模板

### 修订历史
| 版本号 | 作者 | 内容提要 | 发布日期 |
|  ----  | ----  | ---- | ---- |
| V1.0 | XX | 初稿 | 2020-10-24 |

### 需求背景
xxxx
### 需求目标
xxxx
### 相关资源
- prd(@xx): XXX  交互稿(@xx): XXX  视觉稿(@xx): XXX
- 后端系分: XXX、API 列表

### 功能分析
> 1.模块交互截图 2.展示要素分析 3.时序图（包含系统交互、用户行为交互）

#### 模块A
xxxx
#### 模块B
xxxx

特殊模块分析(可选)
1.特殊功能描述
2.实现思路流程图？依赖的框架、类库？
3.性能表现，是否需要降级？降级的维度：钱包版本、系统版本、小程序版本?
4.兼容性，稳定性方案

### 监控设计
核心业务数据监控。异常监控告警。

### 灰度方案
服务端、客户端、配置项灰度方案。

### 应急方案
写操作熔断方案、核心模块熔断、应急提示（小黄条）

### 埋点方案
1.页面访问埋点 2.链路行动点曝光+点击 3.特殊业务埋点

### 技术沉淀
1.沉淀一个组件？ 2.沉淀一个模板？ 3.沉淀一套解决方案？

### 项目管理

#### 工作量评估

| 功能点 | 工作量 | 需求优先级 | 责任人 |
|  ----  | ----  | ---- | ---- |
| 模块A | X天 | P0 | 小马 |
| 模块B | X天 | P0 | 小马 |
| 模块C | X天 | P1 | 小马 |

#### 项目风险点
#### 项目详细计划表
#### 发布checkList

